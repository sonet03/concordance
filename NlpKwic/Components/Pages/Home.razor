@page "/"
@rendermode InteractiveServer
@using Lemmatizer
@using NlpKwic.Components.Models
@using NlpKwic.Components.Services
@inject ConcordanceService ConcordanceCalculator
@inject WebpageTextExtractorService TextExtractor

<h3>Програма конкордансу (X-1, X, X+1)</h3>
<p>Введіть текст вручну або завантажте його з веб-сторінки.</p>

<div class="row">
    @*
    <div class="col-12 mb-3">
        <div class="form-group">
            <label for="urlInput">1. Вставте URL для аналізу:</label>
            <div class="input-group">
                <InputText @bind-Value="_urlInput" id="urlInput" class="form-control" placeholder="https://..."/>
                <button class="btn btn-secondary" @onclick="FetchTextFromUrl" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                        <span>Завантаження...</span>
                    }
                    else
                    {
                        <span>Отримати текст</span>
                    }
                </button>
            </div>
        </div>
    </div>
*@
    <div class="col-md-6">
        <div class="form-group">
            <label for="textInput">1. Вхідний текст (редагується):</label>
            <InputTextArea @bind-Value="_textInput" id="textInput" class="form-control" rows="15"/>
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label for="targetWord">2. Шукана словоформа (або лема):</label>
            <InputText @bind-Value="_targetWord" id="targetWord" class="form-control"/>
        </div>

        <button class="btn btn-primary mt-3 w-100" @onclick="ProcessText" disabled="@string.IsNullOrWhiteSpace(_textInput)">
            Знайти оточення
        </button>
    </div>
</div>

<hr />

@if (_isProcessed && !_results.Any())
{
    <div class="alert alert-warning">
        Словоформу "@_targetWord" не знайдено у тексті.
    </div>
}
else if (_results.Any())
{
    <h4>Результати пошуку (@_results.Count знайдено):</h4>
    <table class="table table-striped table-bordered table-hover">
        <thead class="thead-dark">
        <tr>
            <th style="width: 40%; text-align: right;">Ліве оточення (X-1)</th>
            <th style="width: 20%; background-color: #ffc;">Ключове слово (X)</th>
            <th style="width: 40%;">Праве оточення (X+1)</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var result in _results)
        {
            <tr>
                <td style="text-align: right; padding-right: 15px;">@result.Left</td>
                <td style="font-weight: bold; text-align: center; background-color: #fff9d7;">@result.Middle</td>
                <td style="padding-left: 15px;">@result.Right</td>
            </tr>
        }
        </tbody>
    </table>
}


@code {
    private string _urlInput = string.Empty;
    private string _textInput = string.Empty;
    private string _targetWord = string.Empty;
    
    private List<ConcordanceResult> _results = new();
    private bool _isProcessed;
    private bool _isLoading;

    private async Task FetchTextFromUrl()
    {
        if (string.IsNullOrWhiteSpace(_urlInput))
        {
            _textInput = "Please enter a URL.";
            return;
        }

        _isLoading = true;
        _isProcessed = false;
        _results.Clear();

        _textInput = await TextExtractor.GetTextFromUrlAsync(_urlInput);
        
        _isLoading = false;
    }

    private void ProcessText()
    {
        if (string.IsNullOrWhiteSpace(_textInput) || string.IsNullOrWhiteSpace(_targetWord))
        {
            return;
        }

        _isProcessed = true;
        _results = ConcordanceCalculator.GenerateConcordance(_textInput, _targetWord);
    }
}